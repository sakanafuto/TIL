# CQRS

### CQS

基本的な考えは、オブジェクトのメソッドを明確に 2 つのカテゴリに分類するというものである。

- 問い合わせ：結果を返し、システムの状態を変更しない（副作用がない）
- コマンド：システムの状態を変更し、値を返さない

### CQRS

コマンドクエリ分離原則（CQS）をオブジェクト指向としてだけではなく、アーキテクチャとして定義したものである。

## DDD における参照系の問題点

DDD で定義されている実装パターンを使っていると、基本的には永続化層との入出力は Repository 層を使うことになる。 更新系の処理では Entity や ValueObject でドメインの知識を表現し、Repository 層を介して集約単位で永続化するという構成をとると、非常にメンテナンス性の良いものとなる。

一方、参照系の処理、特に一覧画面のような処理では、複数集約の値を組み合わせた結果を画面に返そうとすることが多くなり、Repository 層の負担が多くなる。

- 複数の集約から値を取得して戻り値の型に詰め替える処理が、ループが増えて読みにくいコードになる
- 画面に返す必要のない値を一度取得するのでパフォーマンスが悪化する
- 複数集約の条件(where)で絞り込んでのページングができない(今回の事例では、タスクの担当者名と、ラベル名と、タスク名で同時に検索をしてページングしようとするようなケース。ページングを 1 つの集約の結果だけで考えられない)

## 解決策としての CQRS

![](/assets/cqrs_2.png)

| 名前         | 具体例                                                                                                  | UseCase の DB アクセス方法                          |
| ------------ | ------------------------------------------------------------------------------------------------------- | --------------------------------------------------- |
| 更新系モデル | DDD の Entity、ValueObject など                                                                         | Repository 層                                       |
| 参照系モデル | 特定のユースケースに特化した値の型。SQL の結果 1 レコードを 1 つの型にするなど (DTO といった命名をする) | 専用のオブジェクト(QueryService といった命名をする) |

---

QueryService の Interface と戻りの型を UseCase 層に、実装クラスは Repository と同様に Infrastructure 層に配置する。UseCase からは「このような条件を指定すると、このような型で返ってくる」というという抽象的な知識だけ持ち、実装の知識は Infrastructure 層に隠蔽する。

コマンドは UseCase 層や Model 層（Domain 層）から Repository 層を介して更新（Command）を行い、参照（Query）は基本 Repository 層から参照し、複雑化したら UseCase 層で DTO を定義して引っ張ってくる的な？

![](/assets/cqrs_1.png)
_CQRS の考え方_

そもそも Graphql なら Repository 層を介さず Infrastructure 層（Data 層）から引っ張ってこれる（Query の役割を担える？）。

## デメリット

デメリットもある。

- オブジェクトの属性が参照されている場所が追いにくくなる
- 元は Getter の参照を追えば確実だったが、別の手段を考える必要が生まれる
- アーキテクチャ自体が複雑になり、解説が必要になる

## まとめ

**「必要なところだけ参照に特化したモデルを導入する」といった使い方が適切である。**

## 参考

- [CQRS 実践入門\[DDD\]](https://little-hands.hatenablog.com/entry/2019/12/02/cqrs)
- [コマンド・クエリという考え方](https://qiita.com/pakkun/items/7dc5a9b6bc57225a3673)
